<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My SmartFarm Devices</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .top-bar .action-buttons a {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="top-bar">
        <h2>Welcome, {{ username }}</h2>
        <div class="action-buttons">
          <a href="/registerdevice" class="btn btn-success">Register Device</a>
          <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
      </div>
      <h3>Your Devices</h3>
      {% if devices %}
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>#</th>
            <th>Device ID</th>
            <th>Plant Name</th>
            <th>Temperature (Â°C)</th>
            <th>Moisture (%)</th>
            <th>Light (lux)</th>
            <th>Last Watered</th>
            <th>Actions</th>
            <th>History</th>
          </tr>
        </thead>
        <tbody>
          {% for device in devices %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ device.device_id }}</td>
            <td>{{ device.plant_name }}</td>
            <td>{{ device.current_temp }}</td>
            <td>{{ device.current_moisture }}</td>
            <td>{{ device.current_light }}</td>
            <td>{{ device.last_watered }}</td>
            <td>
              <div class="btn-group" role="group" aria-label="Device Actions">
                <button
                  class="btn btn-primary btn-sm analyze-disease-btn"
                  data-device-id="{{ device.device_id }}"
                >
                  Analyze Disease
                </button>
                <button
                  class="btn btn-success btn-sm water-plant-btn"
                  data-device-id="{{ device.device_id }}"
                >
                  Water Plant
                </button>
                <button
                  class="btn btn-warning btn-sm light-plant-btn"
                  data-device-id="{{ device.device_id }}"
                >
                  Light Plant
                </button>
              </div>
            </td>
            <td>
              <button
                class="btn btn-info btn-sm view-history-btn"
                data-device-id="{{ device.device_id }}"
              >
                View History
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="alert alert-warning">
        No devices found. <a href="/registerdevice">Register a device</a>
      </div>
      {% endif %}
    </div>

    <!-- Disease Analysis Modal -->
    <div
      class="modal fade"
      id="diseaseAnalysisModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="diseaseAnalysisModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="diseaseAnalysisModalLabel">
              Disease Analysis Result
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="loading" style="text-align: center">
              <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p>Analyzing disease...</p>
            </div>
            <div id="analysis-result" style="display: none">
              <p><strong>Evaluation:</strong> <span id="evaluation"></span></p>
              <p>
                <strong>Health Percentage:</strong>
                <span id="healthPercentage"></span>%
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div
      class="modal fade"
      id="historyModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="historyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="historyModalLabel">Device History</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ul id="history-list" class="list-group">
              <!-- History items will be dynamically added -->
            </ul>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Generic function to handle actions
        function handleAction(url, modalTitle, updateModal = false) {
          const modal = $("#diseaseAnalysisModal");
          const modalBody = document.querySelector(
            "#diseaseAnalysisModal .modal-body"
          );
          const modalTitleElement = document.getElementById(
            "diseaseAnalysisModalLabel"
          );

          // Reset modal content
          modalBody.innerHTML = `
            <div id="loading" style="text-align: center;">
              <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p>Loading...</p>
            </div>
          `;
          modalTitleElement.textContent = modalTitle;

          // Show modal
          modal.modal("show");

          // Fetch action result
          fetch(url)
            .then((response) => response.json())
            .then((data) => {
              if (data.status === 200 && data.data && data.data.result) {
                if (updateModal) {
                  // For disease analysis, update specific fields
                  modalBody.innerHTML = `
                    <div id="analysis-result">
                      <p><strong>Evaluation:</strong> ${data.data.result.evaluation}</p>
                      <p><strong>Health Percentage:</strong> ${data.data.result.healthPercentage}%</p>
                    </div>
                  `;
                } else {
                  // For water or light actions
                  modalBody.innerHTML = `
                    <div class="alert alert-success" role="alert">
                      ${data.message}
                    </div>
                  `;
                }
              } else {
                modalBody.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    ${data.message || "Action failed."}
                  </div>
                `;
              }
            })
            .catch((error) => {
              console.error("Error performing action:", error);
              modalBody.innerHTML = `
                <div class="alert alert-danger" role="alert">
                  An error occurred. Please try again.
                </div>
              `;
            });
        }

        // Add event listeners for each action
        document.querySelectorAll(".analyze-disease-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const deviceId = button.getAttribute("data-device-id");
            handleAction(
              `/analyzedisease/${deviceId}`,
              "Disease Analysis Result",
              true
            );
          });
        });

        document.querySelectorAll(".water-plant-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const deviceId = button.getAttribute("data-device-id");
            handleAction(`/water/${deviceId}`, "Watering Result");
          });
        });

        document.querySelectorAll(".light-plant-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const deviceId = button.getAttribute("data-device-id");
            handleAction(`/light/${deviceId}`, "Lighting Result");
          });
        });

        // History functionality
        document.querySelectorAll(".view-history-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const deviceId = button.getAttribute("data-device-id");
            const historyList = document.getElementById("history-list");
            const modalTitle = document.getElementById("historyModalLabel");

            // Reset modal content
            historyList.innerHTML = `
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p>Loading history...</p>
            `;
            modalTitle.textContent = `History for ${deviceId}`;

            // Show modal
            $("#historyModal").modal("show");

            // Fetch history data
            fetch(`/history/${deviceId}`)
              .then((response) => response.json())
              .then((data) => {
                if (data.status === 200 && data.data && data.data.result) {
                  const history = data.data.result;

                  // Populate history list
                  historyList.innerHTML = history
                    .map((entry) => `<li class="list-group-item">${entry}</li>`)
                    .join("");
                } else {
                  historyList.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                      No history available for this device.
                    </div>
                  `;
                }
              })
              .catch((error) => {
                console.error("Error fetching history:", error);
                historyList.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    Failed to load history. Please try again later.
                  </div>
                `;
              });
          });
        });
      });
    </script>
  </body>
</html>
